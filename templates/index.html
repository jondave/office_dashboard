<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Dashboard</title>

    <script src="https://cdn.plot.ly/plotly-2.18.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header>
    Office Dashboard
    
    <img src="{{ url_for('static', filename='duck.png') }}" height="30px">
</header>

<div class="info-container">
    <div class="info">
        <h2>Office Conditions</h2>
        <p>Current Temperature: <span id="currentTemperature">--</span> ¬∞C</p>
        <p>Average Temperature (Last 5 minutes): <span id="averageTemperature5Min">--</span> ¬∞C</p>
        <p>Average Temperature (Last 5 days): <span id="averageTemperature5Days">--</span> ¬∞C</p>
    </div>

    <div class="info" id="gone-pub" style="display: none; text-align: center; font-size: 2em; padding: 20px;">
        Gone Pub üçª
    </div>
</div>

<div class="container">
    <div class="chart-container" id="temperatureChart"></div>
    <div class="chart-container" id="humidityChart"></div>
</div>

<div class="info-container">
    <div class="bus-info, info">
        <h2>Campus Linc Shuttle Bus</h2>
        <p id="next-departure">Loading next departure...</p>
    </div>

    <div class="info">
        <h2>News</h2>
        <ul id="newsList"></ul>
    </div>

    <!-- <div class="info" id="departuresInfo">
        <h2>Humberside Airport Departures</h2>
        <ul id="departuresList">
            <li>Loading departures...</li>
        </ul>
    </div> -->

    <div class="info" id="weatherInfo">
        <h2>Weather</h2>
        <p>Loading weather data...</p>
    </div>
</div>

<div class="info-container">
    <div class="info" id="trainDepartures">
        <h2>Train Departures</h2>
        <p>Loading departures...</p>
    </div>

    
    <div class="info bus_map_container">
        <h2>Live Busses</h2>
        <div id="map_bus"></div>
    </div>
</div>

<footer>
    &copy; 2024 Ducking Duck Ltd.
    
    <img src="{{ url_for('static', filename='duck.png') }}" height="15px">
</footer>

<script>
    const socket = io();

    // Initialize Plotly charts
    const temperatureLayout = {
        title: 'Temperature (¬∞C)',
        xaxis: { title: 'Time' },
        yaxis: { title: 'Temperature (¬∞C)' },
        margin: { t: 50, r: 30, l: 50, b: 50 }
    };
    const humidityLayout = {
        title: 'Humidity (%)',
        xaxis: { title: 'Time' },
        yaxis: { title: 'Humidity (%)' },
        margin: { t: 50, r: 30, l: 50, b: 50 }
    };

    Plotly.newPlot('temperatureChart', [{ x: [], y: [], mode: 'lines', line: { color: 'red' } }], temperatureLayout);
    Plotly.newPlot('humidityChart', [{ x: [], y: [], mode: 'lines', line: { color: 'blue' } }], humidityLayout);

    socket.on('new_data', function (data) {
        Plotly.extendTraces('temperatureChart', { x: [[data.time]], y: [[data.temperature]] }, [0]);
        Plotly.extendTraces('humidityChart', { x: [[data.time]], y: [[data.humidity]] }, [0]);

        document.getElementById('currentTemperature').innerText = data.current_temperature.toFixed(2);
        document.getElementById('averageTemperature5Min').innerText = data.average_temperature_5min.toFixed(2);
        document.getElementById('averageTemperature5Days').innerText = data.average_temperature_5days.toFixed(2);
    });

    // Bus schedule logic
    const departures = ["07:30", "08:30", "13:00", "16:40", "17:40"];

    function getNextBus() {
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes(); // Minutes since midnight

        const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 5 = Friday, 6 = Saturday

        // Check if it's the weekend (Saturday or Sunday)
        if (dayOfWeek === 0 || dayOfWeek === 6) {
            document.getElementById("next-departure").textContent = `Next Departure: ${departures[0]} (Monday)`;
            return;
        }

        // Loop through the departure times to find the next bus
        for (let i = 0; i < departures.length; i++) {
            const [depHour, depMin] = departures[i].split(':').map(Number);
            const depTime = depHour * 60 + depMin;

            if (depTime >= currentTime) {
                document.getElementById("next-departure").textContent = `Next Departure: ${departures[i]}`;
                return;
            }
        }

        // If no more buses today, show the first departure of the next week (Monday)
        if (dayOfWeek === 5) { // If it's Friday
            document.getElementById("next-departure").textContent = `Next Departure: ${departures[0]} (Monday)`;
        } else { // If it's any weekday other than Friday
            document.getElementById("next-departure").textContent = `Next Departure: ${departures[0]} (Tomorrow)`;
        }
    }

    // Load bus times every 10 minutes (600,000 milliseconds)
    setInterval(getNextBus, 600000); // Adjust interval as needed
    getNextBus(); // Initial load


    function loadNews() {
        fetch('/news')
            .then(response => response.json())
            .then(data => {
                const newsList = document.getElementById('newsList');
                newsList.innerHTML = '';

                if (data.error) {
                    newsList.innerHTML = `<li>Error loading news: ${data.error}</li>`;
                    return;
                }

                data.forEach(news => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<a href="${news.link}" target="_blank">${news.title}</a>`;
                    newsList.appendChild(listItem);
                });
            })
            .catch(error => {
                console.error('Error fetching news:', error);
            });
    }

    // Load the news on page load
    setInterval(loadNews, 60000);
    loadNews();

    function loadWeather(cityId) {
        fetch(`/weather/${cityId}`)
            .then(response => response.json())
            .then(data => {
                const weatherInfo = document.getElementById('weatherInfo');

                if (data.error) {
                    weatherInfo.innerHTML = `<p>Error loading weather: ${data.error}</p>`;
                    return;
                }

                // Check if the weather ID is 800 clear sky
                let additionalImage;

                if (data.id === 800 || data.id === 801) {
                    additionalImage = '<img src="{{ url_for('static', filename='sun.jpg') }}" alt="${data.description}" />';
                } else {
                    additionalImage = '<img src="{{ url_for('static', filename='rain.jpg') }}" alt="${data.description}" />';
                }

                // <h2>Weather Information</h2>
                // <p>Temperature: ${data.temperature} ¬∞C</p>
                // <p>Condition: ${data.description}</p>    
                //<img src="http://openweathermap.org/img/wn/${data.icon}.png" alt="${data.description}" />

                weatherInfo.innerHTML = `
                    <h2>Weather</h2>
                    <p>${data.temperature} ¬∞C - ${data.description}</p>
                    <img src="http://openweathermap.org/img/wn/${data.icon}.png" alt="${data.description}" class="weather_icon" />
                    <h2>Rob Forecast</h2>
                    ${additionalImage}
                `;
            })
            .catch(error => console.error('Error fetching weather:', error));
    }

    // Load weather every 10 minutes (600,000 milliseconds)
    setInterval(() => loadWeather('Lincoln,GB'), 600000);
    loadWeather('Lincoln,GB'); // Initial load

    function checkPubTime() {
        const now = new Date();
        const day = now.getDay(); // 5 is Friday (0 = Sunday, 6 = Saturday)
        const hours = now.getHours();

        const isFriday = day === 5;
        const isPubTime = hours >= 17 && hours < 22; // Between 5:00 PM and 10:00 PM

        const pubDiv = document.getElementById('gone-pub');
        if (isFriday && isPubTime) {
            pubDiv.style.display = 'block'; // Show the message
        } else {
            pubDiv.style.display = 'none'; // Hide the message
        }
    }

    // Check every minute if it's pub time (60000 milliseconds)
    setInterval(checkPubTime, 60000);
    checkPubTime(); // Initial check when the page loads

    function loadTrainDepartures(departureStation = 'LCN') {
        fetch(`/train_departures/${departureStation}`)
            .then(response => response.json())
            .then(data => {
                const trainDepartures = document.getElementById('trainDepartures');

                if (data.error) {
                    trainDepartures.innerHTML = `<p>Error loading departures: ${data.error}</p>`;
                    return;
                }

                let departuresHtml = `
                    <h2>${data.station_name} Departures</h2>
                    <table id="trainSchedule">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Destination</th>
                            <th>Platform</th>
                            <th>Expected</th>
                            <th>Operator</th>
                        </tr>
                    </thead>
                `;
                departuresHtml += '<tbody>';
                data.departures.forEach(departure => {
                    departuresHtml += `
                        <tr>
                            <td>${departure.std}</td>
                            <td>${departure.destination_name}</td>
                            <td>${departure.platform}</td>
                            <td>${departure.etd}</td>
                            <td>${departure.operator}</td>
                        </tr>
                    `;
                });
                departuresHtml += '</tbody></table>';

                trainDepartures.innerHTML = departuresHtml;
            })
            .catch(error => console.error('Error fetching departures:', error));
    }

    // Load train departures every 30 seconds
    setInterval(() => loadTrainDepartures('LCN'), 30000);
    loadTrainDepartures('LCN'); // Initial load

    // function loadDepartures() {
    //     fetch('/departures_airport')
    //         .then(response => response.json())
    //         .then(data => {
    //             const departuresList = document.getElementById('departuresList');
    //             departuresList.innerHTML = '';

    //             if (data.error) {
    //                 departuresList.innerHTML = `<li>Error loading departures: ${data.error}</li>`;
    //                 return;
    //             }

    //             data.forEach(departure => {
    //                 const listItem = document.createElement('li');
    //                 listItem.innerHTML = `${departure.flight_number} to ${departure.destination} at ${new Date(departure.departure_time).toLocaleString()}`;
    //                 departuresList.appendChild(listItem);
    //             });
    //         })
    //         .catch(error => {
    //             console.error('Error fetching departures:', error);
    //         });
    // }

    // // Load the departures on page load
    // setInterval(loadDepartures, 60000);
    // loadDepartures();
    
    // Initialize the bus map
    const map = L.map('map_bus').setView([53.22661638788088, -0.5430025089888347], 15);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Create a custom bus icon
    const busIcon = L.icon({
        iconUrl: '{{ url_for('static', filename='bus_icon.svg') }}',  // Change this to your bus icon URL
        iconSize: [30, 30],  // Size of the icon
        iconAnchor: [15, 30],  // Point of the icon which will correspond to marker's location
        popupAnchor: [0, -30]  // Point from which the popup should open relative to the iconAnchor
    });

    // Function to fetch GeoJSON data and update the map
    function updateMap() {
        fetch('/bus_data')
            .then(response => response.json())
            .then(geojsonData => {
                // Clear existing layers
                map.eachLayer(function (layer) {
                    if (layer instanceof L.GeoJSON) {
                        map.removeLayer(layer);
                    }
                });

                // Add new GeoJSON layer to the map
                L.geoJSON(geojsonData, {
                    pointToLayer: function (feature, latlng) {
                        const marker = L.marker(latlng, { icon: busIcon });
                        // Bind tooltip with bus line number above the icon
                        marker.bindTooltip(`${feature.properties.lineRef}`, {
                            permanent: true,  // Tooltip will always be visible
                            direction: 'top',  // Position the tooltip above the marker
                            offset: [0, -30],  // Move tooltip 40 pixels above the marker
                            className: 'bus_map_tooltip'  // Custom class for styling
                        }).openTooltip();  // Optional: Open the tooltip on load
                        return marker;
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup(`<strong>Destination:</strong> ${feature.properties.destinationName}<br>
                                        <strong>Origin:</strong> ${feature.properties.originName}<br>
                                        <strong>Line:</strong> ${feature.properties.lineRef}<br>
                                        <strong>Vehicle:</strong> ${feature.properties.vehicleRef}<br>
                                        <strong>Operator:</strong> ${feature.properties.operatorRef}<br>
                                        <strong>Time Data Received:</strong> ${feature.properties.recordedAtTime}`);
                    }
                }).addTo(map);
            })
            .catch(error => {
                console.error('Error fetching GeoJSON data:', error);
            });
    }

    // Initial call to load the map data
    updateMap();

    // Update the map every 30 seconds
    setInterval(updateMap, 30000);

</script>

</body>
</html>